<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="李金珂,jkli@thoughtworks.com"><title>你不知道的 Canvas 表格交互 · 李金珂的小屋</title><meta name="description" content="背景S2 是 AntV 在多维交叉分析表格领域的解决方案，主要用于看数分析，S2 采用 canvas 来进行表格绘制 （基于 易用、高效、强大的 2D 可视化渲染引擎 G ) , 同时内置大量的 交互能力 来辅助用户看数，如 行列联动高亮 单选/多选高亮 刷选高亮 行高列宽动态调整 列头隐藏 等，同"><meta name="keywords" content="Javascript,Node.js"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="李金珂的小屋"><meta name="icon" content="/logos/logo_192.png"><meta name="apple-touch-icon" content="/logos/logo_192.png"><meta name="apple-touch-icon-precomposed" content="/logos/logo_192.png"><meta name="apple-touch-startup-image" content="/logos/logo_192.png"><meta name="Alipay:title" content="李金珂的小屋"><meta name="Alipay:imgUrl" content="/logos/logo_192.png"><meta name="Alipay:desc" content="要想学仙术哪能不吃苦"><meta name="renderer" content="webkit"><meta name="theme-color" content="#fff"><link rel="short icon" href="/logos/logo_192.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><link rel="manifest" href="/manifest.json"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/my.jpeg" style="width:127px;border-radius:50%;margin-bottom:20px;"><h3 title=""><a href="/">李金珂的小屋</a></h3><div class="description"><p>要想学仙术,哪能不吃苦</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="http://weibo.com/金珂珂珂珂"><i class="fa fa-weibo"></i></a></li><li><a target="_blank" rel="noopener" href="http://github.com/lijinke666"><i class="fa fa-github"></i></a></li></ul><div class="switch"><input type="checkbox" id="time"><label for="time">Night</label></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">主页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友情链接</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/my.jpeg"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>你不知道的 Canvas 表格交互</a></h3></div><div class="post-content"><p><a name="oBKDo"></a></p>
<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p><img src="https://cdn.nlark.com/yuque/0/2022/png/275539/1648606912733-cf6aad71-1ad3-4bd0-a495-35acdbc1d817.png#clientId=u29fa2d1b-cfb3-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=392&id=u10e69226&margin=%5Bobject%20Object%5D&name=image.png&originHeight=784&originWidth=1161&originalType=binary&ratio=1&rotation=0&showTitle=false&size=511946&status=done&style=none&taskId=ub86a893a-6c3c-42b5-937a-6acabcd1baa&title=&width=580.5" alt="image.png"><br />S2 是 AntV 在多维交叉分析表格领域的解决方案，主要用于看数分析，S2 采用 <code>canvas</code> 来进行表格绘制 （基于 易用、高效、强大的 2D 可视化渲染引擎 <a target="_blank" rel="noopener" href="https://g-next.antv.vision/">G</a> ) , 同时内置大量的 <a target="_blank" rel="noopener" href="https://s2.antv.vision/zh/examples/gallery#category-%E5%9F%BA%E7%A1%80%E4%BA%A4%E4%BA%92">交互能力</a> 来辅助用户看数，如 <code>行列联动高亮</code> <code>单选/多选高亮</code> <code>刷选高亮</code> <code>行高列宽动态调整</code> <code>列头隐藏</code> 等，同时还支持 <code>自定义交互</code>, 本文主要介绍 S2 是如何实现这些交互的。</p>
<p><a name="KbdqE"></a></p>
<h3 id="DOM-交互和-Canvas-交互的区别"><a href="#DOM-交互和-Canvas-交互的区别" class="headerlink" title="DOM 交互和 Canvas 交互的区别"></a>DOM 交互和 Canvas 交互的区别</h3><p>以单元格点击为例，得益于强大的 <code>CSS3</code>选择器，我们可以准确的监听任意 dom 元素的点击事件</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;cell&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">id</span>=<span class="string">&quot;cell1&quot;</span>&gt;</span>我是第一个单元格<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">id</span>=<span class="string">&quot;cell2&quot;</span>&gt;</span>我是第二个单元格<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cell = <span class="built_in">document</span>.querySelector(<span class="string">&#x27;.cell &gt; li:first-child&#x27;</span>);</span><br><span class="line"></span><br><span class="line">cell.addEventListener(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;第一个单元格：别点我！&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>但是 canvas 就只有一个 <code>&lt;canvas/&gt;</code> dom 元素</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;canvas /&gt;</span><br></pre></td></tr></table></figure>

<p>如何准确的知道点击的是哪个单元格呢？答案是 <code>事件委托</code>+ <code>鼠标坐标</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> canvas = <span class="built_in">document</span>.querySelector(<span class="string">&#x27;canvas&#x27;</span>);</span><br><span class="line"></span><br><span class="line">canvas.addEventListener(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;我点的是哪个单元格？&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在 dom 中，有一个很经典的事件冒泡应用场景，那就是 <code>事件委托</code>, 还是以上面的例子，我们可以只监听父级的 <code>ul</code>元素，根据当前的 <code>event.target</code> 来判断当前点击的是哪一个单元格</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cell = <span class="built_in">document</span>.querySelector(<span class="string">&#x27;.cell&#x27;</span>);</span><br><span class="line"></span><br><span class="line">cell.addEventListener(<span class="string">&#x27;click&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> CELL_ID = <span class="string">&#x27;cell1&#x27;</span>;</span><br><span class="line">  <span class="keyword">if</span> (event.target?.id === CELL_ID) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&#x27;我是第一个单元格&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>所以在 <code>canvas</code>中，我们也可以依葫芦画瓢，不同点是，单元格不再是一个个的 dom 节点，而是一个个 canvas 图形 对应的数据结构，类似于虚拟 dom<br /><img src="https://cdn.nlark.com/yuque/0/2022/png/275539/1648606912447-10e65368-1a14-4612-9978-7a317215fbf9.png#clientId=u29fa2d1b-cfb3-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=204&id=u9d24b597&margin=%5Bobject%20Object%5D&name=image.png&originHeight=407&originWidth=1422&originalType=binary&ratio=1&rotation=0&showTitle=false&size=359621&status=done&style=none&taskId=ue7f9ac3d-f793-462e-8333-84df733e036&title=&width=711" alt="image.png"></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cell = <span class="keyword">new</span> Shape(&#123; <span class="attr">type</span>: <span class="string">&#x27;rect&#x27;</span> &#125;);</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> getCell&lt;T <span class="keyword">extends</span> S2CellType = S2CellType&gt;(event): T &#123;</span><br><span class="line">  <span class="keyword">let</span> parent = event.target;</span><br><span class="line">  <span class="comment">// 判断当前 target 属于哪一个实例</span></span><br><span class="line">  <span class="keyword">while</span> (parent &amp;&amp; !(parent <span class="keyword">instanceof</span> Canvas)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (parent <span class="keyword">instanceof</span> BaseCell) &#123;</span><br><span class="line">      <span class="comment">// 在单元格中，返回 true</span></span><br><span class="line">      <span class="keyword">return</span> parent <span class="keyword">as</span> T;</span><br><span class="line">    &#125;</span><br><span class="line">    parent = parent.get?.(<span class="string">&#x27;parent&#x27;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// antv/g 提供的 Canvas 构造器</span></span><br><span class="line"><span class="keyword">const</span> canvas = <span class="keyword">new</span> Canvas()</span><br><span class="line"></span><br><span class="line">canvas.on(<span class="string">&#x27;click&#x27;</span>, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> cell = <span class="built_in">this</span>.getCell(event)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><a name="O66WD"></a></p>
<h3 id="事件分类"><a href="#事件分类" class="headerlink" title="事件分类"></a>事件分类</h3><p>通过事件委托，能够获取到具体触发事件的单元格 ( <a target="_blank" rel="noopener" href="https://github.com/antvis/S2/blob/master/packages/s2-core/src/interaction/event-controller.ts">具体实现</a> )</p>
<ul>
<li>角头单元格点击：<code>S2Event.CORNER_CELL_CLICK</code></li>
<li>列头单元格点击：<code>S2Event.COL_CELL_CLICK</code></li>
<li>行头单元格点击：<code>S2Event.ROW_CELL_CLICK</code></li>
<li>数据单元格点击：<code>S2Event.DATA_CELL_CLICK</code></li>
<li>单元格双击</li>
<li>单元格右键</li>
<li>…</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/275539/1648606910934-f30739dd-f51a-4fd5-a684-4af10e098ad5.png#clientId=u29fa2d1b-cfb3-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=192&id=udc517556&margin=%5Bobject%20Object%5D&name=image.png&originHeight=206&originWidth=625&originalType=binary&ratio=1&rotation=0&showTitle=false&size=57719&status=done&style=none&taskId=u9c8f31ca-0c83-42da-89d5-986edd6092f&title=&width=583.5" alt="image.png"><br />在监听到对应事件后，通过内部的 <code>event emitter</code> 分发出去，从而触发对应的单元格事件</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> onCanvasMousedown = <span class="function">(<span class="params">event: CanvasEvent</span>) =&gt;</span> &#123;</span><br><span class="line">   <span class="keyword">const</span> cellType = <span class="built_in">this</span>.spreadsheet.getCellType(event.target);</span><br><span class="line">   <span class="keyword">switch</span> (cellType) &#123;</span><br><span class="line">     <span class="keyword">case</span> CellTypes.DATA_CELL:</span><br><span class="line">       <span class="built_in">this</span>.spreadsheet.emit(S2Event.DATA_CELL_MOUSE_DOWN, event);</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">     <span class="keyword">case</span> CellTypes.ROW_CELL:</span><br><span class="line">       <span class="built_in">this</span>.spreadsheet.emit(S2Event.ROW_CELL_MOUSE_DOWN, event);</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">     <span class="keyword">case</span> CellTypes.COL_CELL:</span><br><span class="line">       <span class="built_in">this</span>.spreadsheet.emit(S2Event.COL_CELL_MOUSE_DOWN, event);</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">     <span class="keyword">case</span> CellTypes.CORNER_CELL:</span><br><span class="line">       <span class="built_in">this</span>.spreadsheet.emit(S2Event.CORNER_CELL_MOUSE_DOWN, event);</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">     <span class="keyword">case</span> CellTypes.MERGED_CELL:</span><br><span class="line">       <span class="built_in">this</span>.spreadsheet.emit(S2Event.MERGED_CELLS_MOUSE_DOWN, event);</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">     <span class="keyword">default</span>:</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.spreadsheet.on(S2event.DATA_CELL_MOUSE_DOWN, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&#x27;数值单元格点击&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><a name="Py8rV"></a></p>
<h3 id="交互分类"><a href="#交互分类" class="headerlink" title="交互分类"></a>交互分类</h3><p>有了分好类的单元格事件，我们就可以将其排列组合。 比如刷选高亮，就对应 数值单元格的 <code>mousedown</code>+ <code>mousemove</code>+ <code>mouseup</code> 事件，再将获取到的单元格 meta 信息存储在状态机，最后根据交互状态进行 canvas 重绘</p>
<table>
<thead>
<tr>
<th>交互类型</th>
<th>名称</th>
<th>适用场景</th>
</tr>
</thead>
<tbody><tr>
<td>全选</td>
<td>ALL_SELECTED</td>
<td>复制</td>
</tr>
<tr>
<td>选中</td>
<td>SELECTED</td>
<td>单选/多选/行列批量选中</td>
</tr>
<tr>
<td>未选中</td>
<td>UNSELECTED</td>
<td>点击空白处，ESC 键重置，偶数次点击单元格</td>
</tr>
<tr>
<td>悬停</td>
<td>HOVER</td>
<td>行列联动高亮</td>
</tr>
<tr>
<td>长时间悬停</td>
<td>HOVER_FOCUS</td>
<td>显示 tooltip</td>
</tr>
<tr>
<td>预选中</td>
<td>PREPARE_SELECT</td>
<td>刷选</td>
</tr>
</tbody></table>
<p><a name="wOgnN"></a></p>
<h3 id="单选高亮"><a href="#单选高亮" class="headerlink" title="单选高亮"></a>单选高亮</h3><p><a target="_blank" rel="noopener" href="https://s2.antv.vision/zh/examples/interaction/basic#click-highlight">在线体验</a><br /><img src="https://cdn.nlark.com/yuque/0/2022/gif/275539/1648606908800-ea484d3b-8bfe-4d5e-a85c-29a7759798fe.gif#clientId=u29fa2d1b-cfb3-4&crop=0&crop=0&crop=1&crop=1&from=drop&id=ufb162afe&margin=%5Bobject%20Object%5D&name=Kapture%202022-03-23%20at%2011.35.49.gif&originHeight=331&originWidth=603&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ub1a43f33-cfdd-4e16-a235-a625f6513d5&title=" alt="Kapture 2022-03-23 at 11.35.49.gif"><br />鼠标左键单击单元格后，会高亮当前单元格，聚焦当前的数据。</p>
<p>在实现上，其实并没有对当前选中单元格做<strong>高亮</strong>操作，而是<strong>置灰</strong>其他所有<strong>非选中状态的</strong>数值单元格，就像一种 <code>聚光灯</code>效果。</p>
<p>通过 <code>cell.getMeta()</code> 拿到渲染时闭包保存的当前单元格信息，然后调用 <code>interaction.changeState</code> 改变当前交互状态，将状态改为 <code>InteractionStateName.SELECTED</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.spreadsheet.on(S2Event.DATA_CELL_CLICK, <span class="function">(<span class="params">event: CanvasEvent</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> cell: DataCell = <span class="built_in">this</span>.spreadsheet.getCell(event.target);</span><br><span class="line">  <span class="keyword">const</span> meta = cell.getMeta();</span><br><span class="line"></span><br><span class="line">  interaction.changeState(&#123;</span><br><span class="line">    <span class="attr">cells</span>: [getCellMeta(cell)],</span><br><span class="line">    <span class="attr">stateName</span>: InteractionStateName.SELECTED,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>最后的 state 为：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cell = &#123;</span><br><span class="line">  <span class="attr">id</span>: <span class="string">&#x27;cell-id&#x27;</span>  <span class="comment">// 单元格唯一标识</span></span><br><span class="line">  <span class="attr">colIndex</span>: <span class="number">0</span>,   <span class="comment">// 列索引</span></span><br><span class="line">  <span class="attr">rowIndex</span>: <span class="number">0</span>    <span class="comment">// 行索引</span></span><br><span class="line">  <span class="attr">type</span>: <span class="string">&#x27;cell-type&#x27;</span> <span class="comment">// 单元格类型</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> state = &#123;</span><br><span class="line">  <span class="attr">name</span>: InteractionStateName.SELECTED,</span><br><span class="line">  <span class="attr">cells</span>: [cell]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来就是获取到当前可视范围内所有的数值单元格，对它们进行更新</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="title">updatePanelGroupAllDataCells</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">  <span class="built_in">this</span>.updateCells(<span class="built_in">this</span>.getPanelGroupAllDataCells());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="title">updateCells</span>(<span class="params">cells: S2CellType[] = []</span>)</span> &#123;</span><br><span class="line">  cells.forEach(<span class="function">(<span class="params">cell</span>) =&gt;</span> &#123;</span><br><span class="line">    cell.update();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每一个单元格实例会有一个 <code>update</code>方法，最终会根据当前的状态 改变单元格背景色透明度 <code>fillOpacity</code></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 简化代码</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">update</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> stateName = <span class="built_in">this</span>.spreadsheet.interaction.getCurrentStateName();</span><br><span class="line">  <span class="keyword">const</span> fillOpacity = stateName === InteractionStateName.SELECTED ? <span class="number">1</span> : <span class="number">0.2</span>;</span><br><span class="line"></span><br><span class="line">  cell.attrs = &#123;</span><br><span class="line">    fillOpacity,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  canvas.draw();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a name="z4yzf"></a></p>
<h3 id="行列联动高亮"><a href="#行列联动高亮" class="headerlink" title="行列联动高亮"></a>行列联动高亮</h3><p><a target="_blank" rel="noopener" href="https://s2.antv.vision/zh/examples/interaction/basic#hover">在线体验</a><br /><img src="https://cdn.nlark.com/yuque/0/2022/gif/275539/1648606908772-b3afff75-108f-4bbb-84c7-b1ce5edc38fe.gif#clientId=u29fa2d1b-cfb3-4&crop=0&crop=0&crop=1&crop=1&from=drop&id=u241a8b1f&margin=%5Bobject%20Object%5D&name=Kapture%202022-03-23%20at%2011.37.06.gif&originHeight=331&originWidth=603&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u5de057d8-67f4-4aa7-92dd-edaad3db167&title=" alt="Kapture 2022-03-23 at 11.37.06.gif"></p>
<p>当鼠标 hover 在数值单元格上时，会同时高亮对应的行头和列头，也就是 <code>十字高亮效果</code>, 便于用户清晰的知道对应关系，实现上首先和单选一样，先改变状态为 <code>InteractionStateName.HOVER</code> 然后绘制当前单元格的黑色边框</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/275539/1648606911403-8bf977cd-c611-4a27-86be-4ed0bccd6f8a.png#clientId=u29fa2d1b-cfb3-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=94&id=uc9912611&margin=%5Bobject%20Object%5D&name=image.png&originHeight=188&originWidth=392&originalType=binary&ratio=1&rotation=0&showTitle=false&size=64708&status=done&style=none&taskId=ucf586d23-28a4-4869-a6e4-5b47c6c0f9f&title=&width=196" alt="image.png"></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.spreadsheet.on(S2Event.DATA_CELL_HOVER, <span class="function">(<span class="params">event: CanvasEvent</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> cell = <span class="built_in">this</span>.spreadsheet.getCell(event.target) <span class="keyword">as</span> S2CellType;</span><br><span class="line">  <span class="keyword">const</span> &#123; interaction, options &#125; = <span class="built_in">this</span>.spreadsheet;</span><br><span class="line">  <span class="keyword">const</span> meta = cell?.getMeta() <span class="keyword">as</span> ViewMeta;</span><br><span class="line"></span><br><span class="line">  interaction.changeState(&#123;</span><br><span class="line">    <span class="attr">cells</span>: [getCellMeta(cell)],</span><br><span class="line">    <span class="attr">stateName</span>: InteractionStateName.HOVER,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">   <span class="built_in">this</span>.updateRowColCells(meta);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>先绘制数值单元格区域的十字高亮，比较当前单元格和 state 存储的 <code>rowIndex</code> / <code>colIndex</code> 是否一致，如果有一个相同就表示处于同一列/行，对其进行高亮</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> currentColIndex = <span class="built_in">this</span>.meta.colIndex;</span><br><span class="line"><span class="keyword">const</span> currentRowIndex = <span class="built_in">this</span>.meta.rowIndex;</span><br><span class="line"><span class="comment">// 当视图内的 cell 行列 index 与 hover 的 cell 一致，绘制 hover 的十字样式</span></span><br><span class="line"><span class="keyword">if</span> (</span><br><span class="line">  currentColIndex === currentHoverCell?.colIndex ||</span><br><span class="line">  currentRowIndex === currentHoverCell?.rowIndex</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="built_in">this</span>.updateByState(InteractionStateName.HOVER);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// 当视图内的 cell 行列 index 与 hover 的 cell 不一致，隐藏其他样式</span></span><br><span class="line">  <span class="built_in">this</span>.hideInteractionShape();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cell.attrs = &#123;</span><br><span class="line">  <span class="attr">backgroundOpacity</span>: <span class="string">&#x27;#color&#x27;</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>接下来是行头和列头，处理有些许不同，由于透视表行头和列头是多维嵌套的，有父子级关系，不能单纯的比较行/列索引，需要额外比较 单元格 id<br /><img src="https://cdn.nlark.com/yuque/0/2022/png/275539/1648606912787-7bf49677-923f-476a-825d-de79964fe9d9.png#clientId=u29fa2d1b-cfb3-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=357&id=ud8a37caf&margin=%5Bobject%20Object%5D&name=image.png&originHeight=714&originWidth=1254&originalType=binary&ratio=1&rotation=0&showTitle=false&size=554433&status=done&style=none&taskId=ubf742774-3c98-4a72-92fd-eb28ef1a63e&title=&width=627" alt="image.png"><br />如图，行头我们需要高亮 <code>浙江省/舟山市</code> 列头需要高亮 <code>家具/沙发/数量</code>, 内部对应存储的 id 为</p>
<ul>
<li><code>浙江省/舟山市</code> =&gt; <code>root[&amp;] 浙江省 [&amp;] 舟山市</code></li>
<li><code>家具/沙发/数量</code> =&gt; <code>root[&amp;] 家具 [&amp;] 沙发 [&amp;]number</code></li>
</ul>
<p><br />所以 <code>浙江省/舟山市</code> 和 <code>家具/沙发/数量</code> 对应的<code>834</code> 数值单元格的 id 为 =&gt; <code>root[&amp;] 浙江省 [&amp;] 舟山市-root[&amp;] 家具 [&amp;] 沙发 [&amp;]number</code>, 最后去看行/列头单元格 id 是否为包含关系，高亮即可</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> allRowHeaderCells = getActiveHoverRowColCells(</span><br><span class="line">  rowId,</span><br><span class="line">  interaction.getAllRowHeaderCells(),</span><br><span class="line">  <span class="built_in">this</span>.spreadsheet.isHierarchyTreeType(),</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">forEach(allRowHeaderCells, <span class="function">(<span class="params">cell: RowCell</span>) =&gt;</span> &#123;</span><br><span class="line">  cell.updateByState(InteractionStateName.HOVER);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><a name="hjLqa"></a></p>
<h3 id="刷选高亮"><a href="#刷选高亮" class="headerlink" title="刷选高亮"></a>刷选高亮</h3><p><a target="_blank" rel="noopener" href="https://s2.antv.vision/zh/examples/interaction/basic#select-highlight">在线体验</a><br /><img src="https://cdn.nlark.com/yuque/0/2022/gif/275539/1648606912223-74ae5075-c781-488f-b138-5ba164d8c704.gif#clientId=u29fa2d1b-cfb3-4&crop=0&crop=0&crop=1&crop=1&from=drop&id=ubbf3a2f7&margin=%5Bobject%20Object%5D&name=Kapture%202022-03-23%20at%2011.40.02.gif&originHeight=331&originWidth=603&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u210f0fbf-01a4-412e-bb14-11126166a37&title=" alt="Kapture 2022-03-23 at 11.40.02.gif"></p>
<p>刷选用于对批量单元格数据汇总，本质是一种拖拽的动作，拖拽结束后，需要选中拖拽起始坐标点对角线矩形区域的所有单元格。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/275539/1648606913009-d0027ffa-041d-4a36-815d-23924ec86444.png#clientId=u29fa2d1b-cfb3-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=373&id=u3e66620a&margin=%5Bobject%20Object%5D&name=image.png&originHeight=380&originWidth=506&originalType=binary&ratio=1&rotation=0&showTitle=false&size=143674&status=done&style=none&taskId=u635b2784-8b79-4aa6-9132-b815d955161&title=&width=497" alt="image.png"></p>
<p>刷选过程中，还需要考虑鼠标已经超过表格区域，此时默认认为用户还想继续刷选可视范围外的单元格 （如有）, 也就是滚动刷选，这个在 <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/478129151">使用 AntV S2 打造大数据表格组件</a> 已有相关介绍。这里就不再赘述。</p>
<p>刷选和其他交互不同，会有一个 <code>预选中</code>状态，如图，会有一个蓝色的预选中蓝色蒙层，并且该区域单元格显示黑色边框，表示松开鼠标后，这些单元格会被选中，用于给用户一个提示<br /><img src="https://cdn.nlark.com/yuque/0/2022/png/275539/1648606913220-520320fd-fd10-406b-85c5-07d058630db6.png#clientId=u29fa2d1b-cfb3-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=197&id=u3244b51a&margin=%5Bobject%20Object%5D&name=image.png&originHeight=394&originWidth=618&originalType=binary&ratio=1&rotation=0&showTitle=false&size=195830&status=done&style=none&taskId=u91953ee1-6f16-4500-8dd3-ec84066c218&title=&width=309" alt="image.png"><br />首先在点击单元格时记录一个刷选起始点，包含 <code>x/y</code>坐标，<code>rowIndex/colIndex</code> 行/列索引等信息</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> getBrushPoint(event: CanvasEvent): BrushPoint &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; scrollY, scrollX &#125; = <span class="built_in">this</span>.spreadsheet.facet.getScrollOffset();</span><br><span class="line">  <span class="keyword">const</span> originalEvent = event.originalEvent <span class="keyword">as</span> unknown <span class="keyword">as</span> OriginalEvent;</span><br><span class="line">  <span class="keyword">const</span> point: Point = &#123;</span><br><span class="line">    <span class="attr">x</span>: originalEvent?.layerX,</span><br><span class="line">    <span class="attr">y</span>: originalEvent?.layerY,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">const</span> cell = <span class="built_in">this</span>.spreadsheet.getCell(event.target);</span><br><span class="line">  <span class="keyword">const</span> &#123; colIndex, rowIndex &#125; = cell.getMeta();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ...point,</span><br><span class="line">    rowIndex,</span><br><span class="line">    colIndex,</span><br><span class="line">    scrollY,</span><br><span class="line">    scrollX,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在刷选结束，鼠标松开后，得到一个完整的刷选信息，最后比较当前单元格是否在这个范围即可</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">  <span class="attr">start</span>: &#123;</span><br><span class="line">    <span class="attr">rowIndex</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">colIndex</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">x</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">y</span>: <span class="number">0</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">end</span>: &#123;</span><br><span class="line">    <span class="attr">rowIndex</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">colIndex</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="attr">x</span>: <span class="number">200</span>,</span><br><span class="line">    <span class="attr">y</span>: <span class="number">200</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">width</span>: <span class="number">200</span>,</span><br><span class="line">  <span class="attr">height</span>: <span class="number">200</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="title">isInBrushRange</span>(<span class="params">meta: ViewMeta</span>)</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; start, end &#125; = <span class="built_in">this</span>.getBrushRange();</span><br><span class="line">  <span class="keyword">const</span> &#123; rowIndex, colIndex &#125; = meta;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    rowIndex &gt;= start.rowIndex &amp;&amp;</span><br><span class="line">    rowIndex &lt;= end.rowIndex &amp;&amp;</span><br><span class="line">    colIndex &gt;= start.colIndex &amp;&amp;</span><br><span class="line">    colIndex &lt;= end.colIndex</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将获取到单元格信息，存储在 state, 然后重绘</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.spreadsheet.on(S2Event.GLOBAL_MOUSE_UP, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> range = <span class="built_in">this</span>.getBrushRange();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">this</span>.spreadsheet.interaction.changeState(&#123;</span><br><span class="line">    <span class="attr">cells</span>: <span class="built_in">this</span>.getSelectedCellMetas(range),</span><br><span class="line">    <span class="attr">stateName</span>: InteractionStateName.SELECTED,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a name="OUHnq"></a></p>
<h3 id="行高列高动态调整"><a href="#行高列高动态调整" class="headerlink" title="行高列高动态调整"></a>行高列高动态调整</h3><p><a target="_blank" rel="noopener" href="https://s2.antv.vision/zh/examples/interaction/basic#resize">在线体验</a><br /><img src="https://cdn.nlark.com/yuque/0/2022/gif/275539/1648606914281-1ff3d457-fe0c-4d9a-8f16-5a1e2d525e05.gif#clientId=u29fa2d1b-cfb3-4&crop=0&crop=0&crop=1&crop=1&from=drop&id=u3cda807b&margin=%5Bobject%20Object%5D&name=Kapture%202022-03-23%20at%2011.41.05.gif&originHeight=331&originWidth=603&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u3cd07b05-f86b-4012-99a6-f7f5e365cac&title=" alt="Kapture 2022-03-23 at 11.41.05.gif"></p>
<p>S2 默认提供 <code>列等宽布局</code> <code>行列等宽布局</code>和 <code>紧凑布局</code> 三种布局方式 (<a target="_blank" rel="noopener" href="https://s2.antv.vision/zh/examples/layout/basic#compact">预览</a>), 也可以拖拽行/列头进行动态调整，要实现这种效果，首先需要绘制调整的热区，也就是如下图这个蓝色的小条，默认情况下是隐藏的，只有在鼠标放在单元格边缘才会显示出来 （还可以 <a target="_blank" rel="noopener" href="https://s2.antv.vision/zh/examples/interaction/advanced#resize-active">自定义热区范围</a> )<br /><img src="https://cdn.nlark.com/yuque/0/2022/png/275539/1648606914360-e9ab1747-eb4c-4851-9070-d841a0843789.png#clientId=u29fa2d1b-cfb3-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=201&id=uf8c22aaf&margin=%5Bobject%20Object%5D&name=image.png&originHeight=151&originWidth=302&originalType=binary&ratio=1&rotation=0&showTitle=false&size=28613&status=done&style=none&taskId=ubfa12ca2-694d-45ee-a2c9-9f1ef4bfe04&title=&width=402" alt="image.png"></p>
<p>细心的同学可能发现了，鼠标放在热区上面，会变成这样一个图标，这个比较有趣，在 <code>CSS</code>中 我们可以给任意元素添加 <code>cursor: col-resize</code> 来实现，在 <code>Canvas</code>中 由于只有 <code>canvas</code>一个 dom 标签，我们则需要判断 <code>hover</code>热区时，给 <code>canvas</code>加上 <code>cursor: col-resize</code> 行内样式，实现同样的效果<br /> <br /><img src="https://cdn.nlark.com/yuque/0/2022/png/275539/1648606914593-67e248db-4824-4719-8d8d-b1e700541387.png#clientId=u29fa2d1b-cfb3-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=109&id=udb14f59c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=218&originWidth=702&originalType=binary&ratio=1&rotation=0&showTitle=false&size=120818&status=done&style=none&taskId=u4cafa156-bce2-405c-92b6-faef31564d2&title=&width=351" alt="image.png"></p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/275539/1648606915363-04adeb7b-e444-4134-90da-6f164d33001e.png#clientId=u29fa2d1b-cfb3-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=128&id=u0127d44b&margin=%5Bobject%20Object%5D&name=image.png&originHeight=255&originWidth=1046&originalType=binary&ratio=1&rotation=0&showTitle=false&size=216214&status=done&style=none&taskId=u058b6b97-1511-4ee4-b90c-419ebffba79&title=&width=523" alt="image.png"></p>
<p>如果把热区全部显示出来，展示的效果如下：</p>
<p>平铺模式：<br /><img src="https://cdn.nlark.com/yuque/0/2022/png/275539/1648606915502-dd538a8b-9e7f-401a-9e8c-bae05a0401e3.png#clientId=u29fa2d1b-cfb3-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=296&id=uc4609b1b&margin=%5Bobject%20Object%5D&name=image.png&originHeight=352&originWidth=618&originalType=binary&ratio=1&rotation=0&showTitle=false&size=125591&status=done&style=none&taskId=uc5885e65-52d9-4652-9417-2cfc525af6e&title=&width=520" alt="image.png"> <br />树状模式：<br /><img src="https://cdn.nlark.com/yuque/0/2022/png/275539/1648606915436-31a0de31-af10-4a05-9794-f772a208183b.png#clientId=u29fa2d1b-cfb3-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=341&id=u9d0cca0e&margin=%5Bobject%20Object%5D&name=image.png&originHeight=398&originWidth=607&originalType=binary&ratio=1&rotation=0&showTitle=false&size=145827&status=done&style=none&taskId=ufa4be6cf-a475-457c-bd33-b014963adfc&title=&width=520" alt="image.png"><br />明细表：<br /><img src="https://cdn.nlark.com/yuque/0/2022/png/275539/1648606915701-66b879e3-bbae-4b1e-a8c7-68660f6331c1.png#clientId=u29fa2d1b-cfb3-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=412&id=u67ce8dd8&margin=%5Bobject%20Object%5D&name=image.png&originHeight=477&originWidth=602&originalType=binary&ratio=1&rotation=0&showTitle=false&size=155182&status=done&style=none&taskId=u69bcb345-e41d-434b-80a5-745804e0819&title=&width=520" alt="image.png"></p>
<p>接下来需要绘制辅助线，和刷选类似，刷选需要显示预选中的遮罩，动态调整需要显示两条辅助线来让用户预览调整之后的单元格宽度</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/275539/1648606915796-ed00f321-598b-4007-87d5-21d552821356.png#clientId=u29fa2d1b-cfb3-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=387&id=u141e268f&margin=%5Bobject%20Object%5D&name=image.png&originHeight=322&originWidth=344&originalType=binary&ratio=1&rotation=0&showTitle=false&size=63801&status=done&style=none&taskId=ua4714741-ca53-4dc8-a2e4-3234e04e755&title=&width=413" alt="image.png"><br />两条线，对应两条 <code>path</code>, 虚线使用 <code>lineDash</code>实现</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> attrs: ShapeAttrs = &#123;</span><br><span class="line">  <span class="attr">path</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">  <span class="attr">lineDash</span>: guideLineDash,</span><br><span class="line">  <span class="attr">stroke</span>: guideLineColor,</span><br><span class="line">  <span class="attr">strokeWidth</span>: size,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 起始参考线</span></span><br><span class="line"><span class="built_in">this</span>.resizeReferenceGroup.addShape(<span class="string">&#x27;path&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">id</span>: RESIZE_START_GUIDE_LINE_ID,</span><br><span class="line">  attrs,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 结束参考线</span></span><br><span class="line"><span class="built_in">this</span>.resizeReferenceGroup.addShape(<span class="string">&#x27;path&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">id</span>: RESIZE_END_GUIDE_LINE_ID,</span><br><span class="line">  attrs,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>在拖动过程中，需要实时更新参考线的位置，需要考虑水平和垂直两种情况，起始点为单元格的底部，结束点为表格区域的底部</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">type</span> === ResizeDirectionType.Horizontal) &#123;</span><br><span class="line">  startResizeGuideLineShape.attr(<span class="string">&#x27;path&#x27;</span>, [</span><br><span class="line">    [<span class="string">&#x27;M&#x27;</span>, offsetX, offsetY],</span><br><span class="line">    [<span class="string">&#x27;L&#x27;</span>, offsetX, guideLineMaxHeight],</span><br><span class="line">  ]);</span><br><span class="line">  endResizeGuideLineShape.attr(<span class="string">&#x27;path&#x27;</span>, [</span><br><span class="line">    [<span class="string">&#x27;M&#x27;</span>, offsetX + width, offsetY],</span><br><span class="line">    [<span class="string">&#x27;L&#x27;</span>, offsetX + width, guideLineMaxHeight],</span><br><span class="line">  ]);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">startResizeGuideLineShape.attr(<span class="string">&#x27;path&#x27;</span>, [</span><br><span class="line">  [<span class="string">&#x27;M&#x27;</span>, offsetX, offsetY],</span><br><span class="line">  [<span class="string">&#x27;L&#x27;</span>, guideLineMaxWidth, offsetY],</span><br><span class="line">]);</span><br><span class="line">endResizeGuideLineShape.attr(<span class="string">&#x27;path&#x27;</span>, [</span><br><span class="line">  [<span class="string">&#x27;M&#x27;</span>, offsetX, offsetY + height],</span><br><span class="line">  [<span class="string">&#x27;L&#x27;</span>, guideLineMaxWidth, offsetY + height],</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<p>这里大写的 <code>M</code>和 <code>L</code> 熟悉 <code>SVG</code>的同学应该清楚，大写表示绝对定位，小写表示相对定位，对应的含义如下：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">M = moveto 移动到</span><br><span class="line">L = lineto 连接一根线到</span><br><span class="line">H = horizontal lineto  水平连线</span><br><span class="line">V = vertical lineto    垂直连线</span><br><span class="line">C = curveto</span><br><span class="line">S = smooth curveto</span><br><span class="line">Q = quadratic Belzier curve</span><br><span class="line">T = smooth quadratic Belzier curveto</span><br><span class="line">A = elliptical Arc     椭圆的线 贝塞尔曲线</span><br><span class="line">Z = closepath          结束当前路径</span><br></pre></td></tr></table></figure>

<p>在拖拽完成后，将最新的单元格高度/宽度保存到 s2Options.style 中，重绘更新后，单元格按照最新的大小渲染即可</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> getResizeWidthDetail(): ResizeDetail &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; start, end &#125; = <span class="built_in">this</span>.getResizeGuideLinePosition();</span><br><span class="line">  <span class="keyword">const</span> width = <span class="built_in">Math</span>.floor(end.x - start.x);</span><br><span class="line">  <span class="keyword">const</span> resizeInfo = <span class="built_in">this</span>.getResizeInfo();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (resizeInfo.effect) &#123;</span><br><span class="line">    <span class="keyword">case</span> ResizeAreaEffect.Cell:</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">eventType</span>: S2Event.LAYOUT_RESIZE_COL_WIDTH,</span><br><span class="line">        <span class="attr">style</span>: &#123;</span><br><span class="line">          <span class="attr">colCfg</span>: &#123;</span><br><span class="line">            <span class="attr">widthByFieldValue</span>: &#123;</span><br><span class="line">              [resizeInfo.id]: width,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a name="rbH4h"></a></p>
<h3 id="链接跳转"><a href="#链接跳转" class="headerlink" title="链接跳转"></a>链接跳转</h3><p><a target="_blank" rel="noopener" href="https://s2.antv.vision/zh/examples/interaction/advanced#pivot-link-jump">在线体验</a><br /><img src="https://cdn.nlark.com/yuque/0/2022/png/275539/1648606917108-cace5345-750d-477a-b671-9f2da9261b18.png#clientId=u29fa2d1b-cfb3-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=333&id=u9bae7ec8&margin=%5Bobject%20Object%5D&name=image.png&originHeight=333&originWidth=603&originalType=binary&ratio=1&rotation=0&showTitle=false&size=110560&status=done&style=none&taskId=ue0cd16e2-7d61-4149-bca9-99b78165b63&title=&width=603" alt="image.png"><br />可以给指定单元格的文字加上下划线，表示可以点击跳转<br />如果使用 <code>DOM</code> 实现，只需要给对应元素加上 <code>a</code> 超链接标签即可，使用 <code>Canvas</code>实现，则需要自己绘制 <code>下划线</code>, 监听点击事件。来模拟 <code>a</code> 标签的效果，核心实现如下</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取当前文字的包围盒</span></span><br><span class="line"><span class="keyword">const</span> &#123; minX, maxX, maxY &#125;: BBox = <span class="built_in">this</span>.textShape.getBBox();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在当前文字下面绘制一根下划线</span></span><br><span class="line"><span class="built_in">this</span>.linkFieldShape = renderLine(</span><br><span class="line">  <span class="built_in">this</span>,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">x1</span>: minX,</span><br><span class="line">    <span class="attr">y1</span>: maxY + <span class="number">1</span>,</span><br><span class="line">    <span class="attr">x2</span>: maxX,</span><br><span class="line">    <span class="attr">y2</span>: maxY + <span class="number">1</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123; <span class="attr">stroke</span>: linkFillColor, <span class="attr">lineWidth</span>: <span class="number">1</span> &#125;,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><a name="SYz9E"></a></p>
<h3 id="列头隐藏"><a href="#列头隐藏" class="headerlink" title="列头隐藏"></a>列头隐藏</h3><p><a target="_blank" rel="noopener" href="https://s2.antv.vision/zh/examples/interaction/advanced#pivot-hide-columns">在线体验</a> <a name="Gw5U7"></a></p>
<h3 id=""><a href="#" class="headerlink" title=""></a><img src="https://cdn.nlark.com/yuque/0/2022/gif/275539/1648606916775-4b705357-43d0-412d-b48e-d3249591f952.gif#clientId=u29fa2d1b-cfb3-4&crop=0&crop=0&crop=1&crop=1&from=drop&id=ub45b4d8f&margin=%5Bobject%20Object%5D&name=Kapture%202022-03-23%20at%2011.42.38.gif&originHeight=331&originWidth=603&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u6895fe19-0d03-4fe4-ac21-1235d3c576f&title=" alt="Kapture 2022-03-23 at 11.42.38.gif"></h3><p>透视表和明细表都支持隐藏列头，首先点击列头，显示 tooltip, 然后点击 tooltip 的 <code>隐藏</code> 按钮，同时支持批量/分组隐藏</p>
<p>首先需要知道当前隐藏的列是否需要分组，如果给定的隐藏列不是连续的，比如原始列是 <code>[1,2,3,4,5,6,7]</code>, 隐藏列是 <code>[2,3,6]</code>, 那么其实在表格上需要显示两个展开按钮 <code>[[2,3],[6]]</code>, 核心代码如下</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getHiddenColumnsThunkGroup = (</span><br><span class="line">  columns: <span class="built_in">string</span>[],</span><br><span class="line">  <span class="attr">hiddenColumnFields</span>: <span class="built_in">string</span>[],</span><br><span class="line">): <span class="built_in">string</span>[][] =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (isEmpty(hiddenColumnFields)) &#123;</span><br><span class="line">    <span class="keyword">return</span> [];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 上一个需要隐藏项的序号</span></span><br><span class="line">  <span class="keyword">let</span> prevHiddenIndex = <span class="built_in">Number</span>.NEGATIVE_INFINITY;</span><br><span class="line">  <span class="keyword">return</span> columns.reduce(<span class="function">(<span class="params">result, field, index</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!hiddenColumnFields.includes(field)) &#123;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (index === prevHiddenIndex + <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> lastGroup = last(result);</span><br><span class="line">      lastGroup.push(field);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> group = [field];</span><br><span class="line">      result.push(group);</span><br><span class="line">    &#125;</span><br><span class="line">    prevHiddenIndex = index;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;, []);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>接下来是生成分组信息</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> detail = &#123;</span><br><span class="line">   <span class="attr">displaySiblingNode</span>: &#123;</span><br><span class="line">     <span class="attr">next</span>: Node, <span class="comment">// 隐藏列的后一个兄弟节点</span></span><br><span class="line">     <span class="attr">prev</span>: Node, <span class="comment">// 隐藏列的前一个兄弟节点</span></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="attr">hideColumnNodes</span>: [Node, ...]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.nlark.com/yuque/0/2022/png/275539/1648606919400-a95f5808-fb9e-4142-b280-bb4e9631833f.png#clientId=u29fa2d1b-cfb3-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=394&id=uef4bc869&margin=%5Bobject%20Object%5D&name=image.png&originHeight=788&originWidth=797&originalType=binary&ratio=1&rotation=0&showTitle=false&size=493941&status=done&style=none&taskId=u7239fad2-5d13-4668-a80b-b1d6075aa86&title=&width=398.5" alt="image.png"><br />有了这些数据，就能知道展开按钮绘制在哪一个单元格上，展开按钮默认显示在后一个兄弟节点，<strong>首尾</strong>单元格被隐藏的情况例外，需要反过来<br /><img src="https://cdn.nlark.com/yuque/0/2022/gif/275539/1648606917203-d43d2c71-a502-458e-8a94-4edfa92cb226.gif#clientId=u29fa2d1b-cfb3-4&crop=0&crop=0&crop=1&crop=1&from=drop&id=ud7ade6e5&margin=%5Bobject%20Object%5D&name=Kapture%202022-03-23%20at%2016.17.17.gif&originHeight=330&originWidth=603&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=uf54e9e62-bc63-4339-82d4-9151e195b9d&title=" alt="Kapture 2022-03-23 at 16.17.17.gif"></p>
<p>除了手动点击进行隐藏，S2 还支持通过声明配置默认隐藏，用于去掉一些不重要数据的干扰，提升看数效率</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/275539/1648606918874-f539459a-b8fb-432b-abe0-5e4c897eb16d.png#clientId=u29fa2d1b-cfb3-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=256&id=u4732a7ad&margin=%5Bobject%20Object%5D&name=image.png&originHeight=264&originWidth=623&originalType=binary&ratio=1&rotation=0&showTitle=false&size=47428&status=done&style=none&taskId=ucd8cfdda-70fb-4a20-88b8-8f377969d80&title=&width=603" alt="image.png"></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> s2DataConfig = &#123;</span><br><span class="line">  <span class="attr">fields</span>: &#123;</span><br><span class="line">    <span class="attr">columns</span>: [<span class="string">&#x27;type&#x27;</span>, <span class="string">&#x27;province&#x27;</span>, <span class="string">&#x27;city&#x27;</span>, <span class="string">&#x27;price&#x27;</span>, <span class="string">&#x27;cost&#x27;</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> s2Options = &#123;</span><br><span class="line">  <span class="attr">interaction</span>: &#123;</span><br><span class="line">    <span class="attr">hiddenColumnFields</span>: [<span class="string">&#x27;province&#x27;</span>, <span class="string">&#x27;price&#x27;</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>对于明细表，一个 <code>field</code> 就只对应一个列头，对于透视表，一个 <code>field</code> 对应一个或多个列头，只指定 <code>field</code> 的话并不知道需要隐藏哪个列头，需要指定对应列头的 <code>id</code><br /><img src="https://cdn.nlark.com/yuque/0/2022/png/275539/1648606919012-65dcdf31-7800-4e10-bbdf-087abfa7572e.png#clientId=u29fa2d1b-cfb3-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=347&id=u5cce7c7c&margin=%5Bobject%20Object%5D&name=image.png&originHeight=341&originWidth=605&originalType=binary&ratio=1&rotation=0&showTitle=false&size=98857&status=done&style=none&taskId=ua2902074-cb5f-4235-8b88-b8c2df3a9dd&title=&width=615.5" alt="image.png"></p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> s2Options = &#123;</span><br><span class="line">  <span class="attr">interaction</span>: &#123;</span><br><span class="line">    <span class="comment">// 透视表默认隐藏需要指定唯一列头 id</span></span><br><span class="line">    <span class="comment">// 可通过 `s2.getColumnNodes()` 获取列头节点查看 id</span></span><br><span class="line">    <span class="attr">hiddenColumnFields</span>: [<span class="string">&#x27;root[&amp;] 家具 [&amp;] 沙发 [&amp;]number&#x27;</span>],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>列头隐藏后，对应的就是展开，展开相对来说就比较简单了，将当前隐藏列配置和展开的列头做一次 <code>diff</code>, 移除相应配置即可</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">private</span> <span class="function"><span class="title">handleExpandIconClick</span>(<span class="params">node: Node</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> lastHiddenColumnsDetail = <span class="built_in">this</span>.spreadsheet.store.get(</span><br><span class="line">      <span class="string">&#x27;hiddenColumnsDetail&#x27;</span>,</span><br><span class="line">      [],</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">const</span> &#123; hideColumnNodes = [] &#125; =</span><br><span class="line">      lastHiddenColumnsDetail.find(<span class="function">(<span class="params">&#123; displaySiblingNode &#125;</span>) =&gt;</span></span><br><span class="line">        isEqualDisplaySiblingNodeId(displaySiblingNode, node.id),</span><br><span class="line">      ) || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="attr">hiddenColumnFields</span>: lastHideColumnFields &#125; =</span><br><span class="line">      <span class="built_in">this</span>.spreadsheet.options.interaction;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> willDisplayColumnFields = hideColumnNodes.map(</span><br><span class="line">      <span class="built_in">this</span>.getHideColumnField,</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">const</span> hiddenColumnFields = difference(</span><br><span class="line">      lastHideColumnFields,</span><br><span class="line">      willDisplayColumnFields,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> hiddenColumnsDetail = lastHiddenColumnsDetail.filter(</span><br><span class="line">      <span class="function">(<span class="params">&#123; displaySiblingNode &#125;</span>) =&gt;</span></span><br><span class="line">        !isEqualDisplaySiblingNodeId(displaySiblingNode, node.id),</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.spreadsheet.setOptions(&#123;</span><br><span class="line">      <span class="attr">interaction</span>: &#123;</span><br><span class="line">        hiddenColumnFields,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="built_in">this</span>.spreadsheet.store.set(<span class="string">&#x27;hiddenColumnsDetail&#x27;</span>, hiddenColumnsDetail);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后我们根据这些配置信息，重新构建布局，渲染隐藏/展开列头后的表格即可</p>
<p><a name="iw3JM"></a></p>
<h3 id="自定义交互"><a href="#自定义交互" class="headerlink" title="自定义交互"></a>自定义交互</h3><p><a target="_blank" rel="noopener" href="https://s2.antv.vision/zh/examples/interaction/custom#row-col-hover-tooltip">在线体验</a><br /><img src="https://cdn.nlark.com/yuque/0/2022/gif/275539/1648606918291-3316e461-5929-4365-9b33-5ce6ca41263e.gif#clientId=u29fa2d1b-cfb3-4&crop=0&crop=0&crop=1&crop=1&from=drop&id=u8aee4031&margin=%5Bobject%20Object%5D&name=Kapture%202022-03-23%20at%2016.33.45.gif&originHeight=330&originWidth=603&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=uab3785ae-d9f9-4f08-968b-2c63310daa5&title=" alt="Kapture 2022-03-23 at 16.33.45.gif"><br />除了上面提到的丰富的内置交互以外，开发者还可以根据 S2 提供的 事件<code>S2Event</code>, 自由排列组合，自定义表格交互，可通过 <code>interaction.customInteractions</code> 注册，比如自定义一个 <code>行列头 hover 显示 tooltip</code> 的交互</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; PivotSheet, BaseEvent, S2Event &#125; <span class="keyword">from</span> <span class="string">&#x27;@antv/s2&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RowColumnHoverTooltipInteraction</span> <span class="keyword">extends</span> <span class="title">BaseEvent</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="title">bindEvents</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 行头 hover</span></span><br><span class="line">    <span class="built_in">this</span>.spreadsheet.on(S2Event.ROW_CELL_HOVER, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.showTooltip(event);</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 列头 hover</span></span><br><span class="line">    <span class="built_in">this</span>.spreadsheet.on(S2Event.COL_CELL_HOVER, <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">this</span>.showTooltip(event);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="title">showTooltip</span>(<span class="params">event</span>)</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> cell = <span class="built_in">this</span>.spreadsheet.getCell(event.target);</span><br><span class="line">    <span class="keyword">const</span> meta = cell.getMeta();</span><br><span class="line">    <span class="keyword">const</span> content = meta.value;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.spreadsheet.tooltip.show(&#123;</span><br><span class="line">      <span class="attr">position</span>: &#123;</span><br><span class="line">        <span class="attr">x</span>: event.clientX,</span><br><span class="line">        <span class="attr">y</span>: event.clientY,</span><br><span class="line">      &#125;,</span><br><span class="line">      content,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> s2Options = &#123;</span><br><span class="line">  <span class="attr">interaction</span>: &#123;</span><br><span class="line">    <span class="attr">customInteractions</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">key</span>: <span class="string">&#x27;RowColumnHoverTooltipInteraction&#x27;</span>,</span><br><span class="line">        <span class="attr">interaction</span>: RowColumnHoverTooltipInteraction,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> s2 = <span class="keyword">new</span> PivotSheet(container, dataCfg, s2Options);</span><br><span class="line"></span><br><span class="line">s2.render();</span><br></pre></td></tr></table></figure>

<p><a name="zSOqp"></a></p>
<h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p>以上就是对于 S2 部分交互实现的一些介绍，除此之外，S2 还支持 <a target="_blank" rel="noopener" href="https://s2.antv.vision/zh/examples/interaction/advanced#merge-cell">合并单元格</a>, <a target="_blank" rel="noopener" href="https://s2.antv.vision/zh/examples/interaction/advanced#scroll-speed-ratio">自定义滚动速度</a> 等丰富的交互，篇幅有限，就不一一列举了。</p>
<p>也欢迎社区的同学和我们一起共建 <a target="_blank" rel="noopener" href="https://github.com/antvis/s2">AntV/S2</a>，打造最强的开源大数据表格引擎。如果看完这篇文章你有所收获，欢迎给我们的 <a target="_blank" rel="noopener" href="https://github.com/antvis/s2">仓库</a> <a target="_blank" rel="noopener" href="https://github.com/antvis/s2">Star⭐️</a> 鼓励。</p>
<p>S2 的相关链接：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/antvis/s2">GitHub</a></li>
<li><a target="_blank" rel="noopener" href="https://s2.antv.vision/">官网</a></li>
<li>核心层：<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/@antv/s2">@antv/s2</a></li>
<li>组件层：<a target="_blank" rel="noopener" href="https://www.npmjs.com/package/@antv/s2-react">@antv/s2-react</a></li>
</ul>
<p><a name="Rs5mZ"></a></p>
<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul>
<li><a href="https://www.lijinke.cn/2019/03/04/%E7%94%A8SVG-%E7%94%BB%E4%B8%80%E4%B8%AA%E5%AD%97/">用 SVG 画一个字</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/478129151">使用 AntV S2 打造大数据表格组件</a></li>
<li><a target="_blank" rel="noopener" href="https://g-next.antv.vision/zh/docs/guide/introduce">AntV/G</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/SVG/Tutorial/Paths">MDN SVG</a></li>
</ul>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2022-03-30</span><i class="fa fa-comment-o"></i><a href="/2022/03/30/%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84-Canvas-%E8%A1%A8%E6%A0%BC%E4%BA%A4%E4%BA%92/#comments">评论</a><i class="fa fa-tag"></i><a class="tag" href="/tags/JavaScript-Canvas/" title="JavaScript,Canvas">JavaScript,Canvas </a></div></div></div></div><div style="margin:30px"><span class="leancloud-visitors" id="/2022/03/30/你不知道的-Canvas-表格交互/"><span class="post-meta-item-text" style="margin-right:5px">阅读量</span><i class="leancloud-visitors-count">1000000</i></span></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://www.lijinke.cn/2022/03/30/你不知道的-Canvas-表格交互/,李金珂的小屋,你不知道的 Canvas 表格交互,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2022/04/15/Canvas-%E6%B5%AE%E7%82%B9%E6%95%B0%E5%9D%90%E6%A0%87%E9%80%A0%E6%88%90%E6%96%87%E5%AD%97%E6%8A%96%E5%8A%A8%E7%9A%84%E9%97%AE%E9%A2%98/" title="Canvas 浮点数坐标造成文字抖动的问题">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2021/06/03/web-%E5%89%8D%E7%AB%AF%E4%B8%AD%E7%9A%84%E9%82%A3%E4%BA%9B-%E6%96%B0%E4%B8%9C%E8%A5%BF/" title="web 前端中的那些&quot;新东西&quot;">下一篇</a></li></ul></div><a id="comments"></a><div id="vcomments" style="margin:0 30px;"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js?v=undefined"></script><script>var valine = new Valine({
  el:'#vcomments',
  //- notify: || false,
  //- verify:|| false,
  notify: true,
  verify: true,
  enableQQ: true,
  recordIP: true,
  app_id:'RBh7EcHesd4twgP5qIos38HM-gzGzoHsz',
  app_key:'f47a9Cg5ea9EVoPSs4KqfE6U',
  placeholder:'留下点什么?',
  path: window.location.pathname,
  avatar:'robohash',
  visitor: true,
})</script></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="https://unpkg.com/darkreader@4.9.32/darkreader.js"></script><script src="/pwa.js"></script><script src="/main.js"></script></body></html>